<head>
  <meta charset="UTF-8" />
  <title>RSI ê²€ìƒ‰</title>
  <style>
    .rounded-box {
      background-color: #fffef3;
      border-radius: 12px;
      padding: 10px;
      margin-top: 10px;
      width: 457px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      height: 500px;
      overflow-y: auto;
      line-height: 18px;
    }

    .kospi-row {
      display: grid;
      grid-template-columns: 23px 143px 67px 80px 80px 1fr;
      row-gap: 4px;
      column-gap: 10px;
      margin-bottom: 4px;
    }

    .kospi-row > div:first-child {
      text-align: right;
    }

    .ilbong-container {
      background-color: #eef8ff;
      border-radius: 12px;
      padding: 10px;
      width: 650px;
      height: 500px;
      overflow: hidden;
      box-sizing: border-box;
    }

    .ilbong-box {
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0;
      box-sizing: border-box;
      background-color: transparent;
    }

    .ilbong-box table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      margin-top: 0;
    }

    .ilbong-box th,
    .ilbong-box td {
      padding: 6px 8px;
      border: 1px solid #ccc;
      font-size: 13px;
      word-wrap: break-word;
    }

    .ilbong-box thead th {
      position: sticky;
      top: 0;
      background-color: #d9ebff;
      z-index: 5;
      text-align: center;
    }

    .ilbong-box tbody td {
      background-color: #eef8ff;
      text-align: center;
    }

    .ilbong-box th:nth-child(1),
    .ilbong-box td:nth-child(1) {
      width: 20%;
    }

    .ilbong-box td:nth-child(2),
    .ilbong-box td:nth-child(3) {
      text-align: right;
    }

    .ilbong-box th:nth-child(2),
    .ilbong-box th:nth-child(3) {
      text-align: center;
    }




  a.stock-link {
    text-decoration: none;
    color: black;
    transition: color 0.3s, font-weight 0.3s;
  }

  a.stock-link:hover,
  a.stock-link.active {
    font-weight: bold !important;
    color: #1E90FF !important;
    text-decoration: none !important;
  }

  a.stock-link:visited {
    color: black;
  }

  </style>

  <script src="https://unpkg.com/htmx.org@1.9.2"></script>

  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/stock/modules/data.js"></script>
  <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/stock/indicators/indicators-all.js"></script> 
  <style>
    /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #chartContainer {
        height: 1000px;
        min-width: 310px;
        margin: 0 auto;
    }
  </style>
    
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.0/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <style>
    #candlestick-container {
      width: 800px;
      height: 400px;
      margin: 20px 0;
    }
    #candlestickChart {
      width: 100%;
      height: 100%;
    }
  </style>

</head>







<body>

  <!-- flexë¡œ ë‚˜ë€íˆ ì •ë ¬ -->
  <div style="display: flex; gap: 20px; align-items: flex-start;">

    <!-- KOSPI ì¡°ê° ë·° -->
    <div id="kospi-box">
      {% include '_kospi_partial.html' with kospi=kospi %}
    </div>

    <!-- ì¼ë´‰ ë°ì´í„° ì˜ì—­ -->
    <div id="box_common_ilbong">
      {% include '_partial_common_ilbong.html' with code=code json_ilbong=json_ilbong %} 
    </div>

  </div>

  <br>

  <!-- ì¢…ëª©ì½”ë“œ ì…ë ¥ í¼ -->
  <form hx-get="{% url '_partial_common_ilbong' %}" hx-target="#box_common_ilbong" hx-swap="innerHTML">
    {% csrf_token %}
    <input type="text" name="code" placeholder="ì¢…ëª©ì½”ë“œ" required>
    <button type="submit">ì¼ë´‰ ë°ì´í„°</button>
  </form>

  <br>

  <!-- KOSPI ê´€ë ¨ ë²„íŠ¼ -->
  <button
    hx-get="{% url '_kospi_partial' %}"
    hx-target="#kospi-box"
    hx-swap="innerHTML">
    ì‹œì´ ìˆœìœ„
  </button>

  <button
    id="bt_rsi"
    hx-get="{% url '_partial_rsi' %}"
    hx-target="#kospi-box"
    hx-swap="innerHTML">
    RSI
  </button>

  <button
    id="bt_macd"
    hx-get="{% url '_partial_macd' %}"
    hx-target="#kospi-box"
    hx-swap="innerHTML">
    MACD
  </button>

  <script>
    let activeCode = null;

    // ë§í¬ í´ë¦­ ì‹œ í˜„ì¬ ì„ íƒëœ ì½”ë“œ ì €ì¥
    function setActive(clicked, code) {
      activeCode = code;

      document.querySelectorAll('.stock-link').forEach(link => {
        link.classList.remove('active'); // ì „ì²´ (ì´ì „ í´ë¦­ëœ) ì¢…ëª© ì½”ë“œì˜ active ì‚­ì œ
      });

      clicked.classList.add('active'); // ë°©ê¸ˆ í´ë¦­ëœ ì¢…ëª© ì½”ë“œ active
    }

    // htmxë¡œ kospi ë·° ë‹¤ì‹œ ë¡œë”©ëœ í›„, active í´ë˜ìŠ¤ ë³µì›
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      if (evt.detail.target.id === 'kospi-box') {
        // ìƒˆë¡œ ë¡œë“œëœ .stock-linkì— onclick ë‹¤ì‹œ ë“±ë¡
        document.querySelectorAll('.stock-link').forEach(link => {
          link.onclick = function() {
            setActive(this, this.dataset.code);
          };
        });

        // ì´ì „ì— í´ë¦­ëœ ë§í¬ê°€ ìˆìœ¼ë©´ active ë³µì›
        if (activeCode) {
          const activeLink = document.querySelector(`.stock-link[data-code='${activeCode}']`);
          if (activeLink) activeLink.classList.add('active');
        }
      }
    });
  </script>

</body>































    <div id="chartContainer"></div>

    <script>
        // ìº”ë“¤ ë° ê±°ë˜ëŸ‰ ìƒ‰ìƒ ì •ì˜ (ìƒìŠ¹: ë¹¨ê°•, í•˜ë½: íŒŒë‘)
        const UP_COLOR = 'red';
        const DOWN_COLOR = 'blue';

        // ----------------------------------------------------------------------
        // 1. ë°ì´í„° ìƒì„± í•¨ìˆ˜ (OHLCV + Colorë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í†µí•©í•˜ì—¬ ë°˜í™˜)
        // ----------------------------------------------------------------------
        function createSampleData() {
            // ğŸš¨ ohlcvData: í•˜ë‚˜ì˜ ë°°ì—´ì— ëª¨ë“  ì •ë³´ë¥¼ ë‹´ìŒ
            const ohlcvData = []; 
            let date = new Date('2025-08-01').getTime();
            let price = 50000;
            
            // 120ì¼ì„ ê¹Œì§€ í‘œì‹œë  ìˆ˜ ìˆë„ë¡ 200ì¼ì¹˜ ë°ì´í„° ìƒì„± (ì´ì „ ìš”ì²­ì‚¬í•­ ë°˜ì˜)
            for (let i = 0; i < 200; i++) { 
                const day = new Date(date).getDay();
                if (day === 0 || day === 6) { 
                    date += 24 * 3600 * 1000;
                    i--;
                    continue;
                }
                const open = price;
                const change = Math.floor(Math.random() * 2000) - 1000; 
                const close = open + change;
                const high = Math.max(open, close) + Math.floor(Math.random() * 500);
                const low = Math.min(open, close) - Math.floor(Math.random() * 500);
                const volume = Math.floor(Math.random() * 100000) + 10000; 
                
                const barColor = (close > open) ? UP_COLOR : DOWN_COLOR;
                
                // ğŸš¨ OHLCV + Color (7ê°œ ìš”ì†Œ)ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ ì €ì¥
                ohlcvData.push([
                    date, 
                    Math.round(open), 
                    Math.round(high), 
                    Math.round(low), 
                    Math.round(close),
                    volume,
                    barColor // ìº”ë“¤ì˜ ìƒ‰ìƒ ì •ë³´
                ]);

                date += 24 * 3600 * 1000;
                price = close;
            }
            return { ohlcvData };
        }
        
        // ----------------------------------------------------------------------
        // 2. ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ (í†µí•© ë°ì´í„°ë¥¼ Highcharts í¬ë§·ìœ¼ë¡œ ë¶„ë¦¬)
        // ----------------------------------------------------------------------
        function processDataForHighcharts(combinedData) {
            const ohlcData = []; 
            const volumeData = []; 
            
            combinedData.ohlcvData.forEach(item => {
                // í†µí•© ë°ì´í„° [ë‚ ì§œ, ì‹œê°€, ê³ ê°€, ì €ê°€, ì¢…ê°€, ê±°ë˜ëŸ‰, ìƒ‰ìƒ]
                const [date, open, high, low, close, volume, color] = item;
                
                // ìº”ë“¤ìŠ¤í‹± ë°ì´í„° (5ê°œ ìš”ì†Œ)
                ohlcData.push([date, open, high, low, close]); 
                
                // ê±°ë˜ëŸ‰ ë°ì´í„° (ê°ì²´ í˜•íƒœ, ìƒ‰ìƒ í¬í•¨)
                volumeData.push({ x: date, y: volume, color: color });
            });
            
            return { ohlcData, volumeData };
        }

        const rawData = createSampleData();
        // ğŸš¨ ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ohlcDataì™€ volumeData ë¶„ë¦¬
        const { ohlcData, volumeData } = processDataForHighcharts(rawData); 
        const mainSeriesId = 'main-series';
        
        // ----------------------------------------------------------------------
        // 3. Highcharts ì°¨íŠ¸ ë Œë”ë§ 
        // ----------------------------------------------------------------------
        Highcharts.stockChart('chartContainer', {

            navigator: { enabled: false }, // ë„¤ë¹„ê²Œì´í„° ì œê±°

            rangeSelector: { selected: 1 },
            title: { text: 'ê°€ìƒ ì£¼ì‹ ì¢…ëª© ì¼ë´‰ ì°¨íŠ¸ (OHLCV í†µí•© ë°ì´í„°)' },
            
            // Yì¶• ì„¤ì • (4ê°œ íŒ¨ë„) 
            yAxis: [{
                title: { text: 'ê°€ê²©' }, height: '40%', lineWidth: 2, resize: { enabled: true }
            }, {
                title: { text: 'ê±°ë˜ëŸ‰' }, top: '45%', height: '15%', offset: 0, lineWidth: 2, labels: { align: 'right', x: -3 }
            }, {
                title: { text: 'RSI' }, top: '65%', height: '15%', offset: 0, lineWidth: 2,
                plotLines: [{ value: 70, color: UP_COLOR, dashStyle: 'shortdash', width: 1, label: { text: '70', align: 'right' }
                }, { value: 30, color: DOWN_COLOR, dashStyle: 'shortdash', width: 1, label: { text: '30', align: 'right' } }]
            }, {
                title: { text: 'MACD' }, top: '85%', height: '15%', offset: 0, lineWidth: 2,
                plotLines: [{ value: 0, color: '#000000', width: 1 }]
            }],

            // ì‹œë¦¬ì¦ˆ ì„¤ì •
            series: [{
                // ì‹œë¦¬ì¦ˆ 0: ìº”ë“¤ìŠ¤í‹± (ê°€ê²©)
                id: mainSeriesId, 
                type: 'candlestick', 
                name: 'ê°€ìƒ ì¢…ëª©', 
                data: ohlcData, // ë¶„ë¦¬ëœ OHLC ë°ì´í„° ì‚¬ìš©
                
                // ìº”ë“¤ ìœ¤ê³½ì„  ë° ê¼¬ë¦¬ ìƒ‰ìƒ ì„¤ì •
                color: DOWN_COLOR, upColor: UP_COLOR, 
                lineColor: DOWN_COLOR, upLineColor: UP_COLOR,
                
                dataGrouping: { units: [['day', [1]]] }
            }, {
                // ì‹œë¦¬ì¦ˆ 1: ê±°ë˜ëŸ‰ (Volume) - ë¶„ë¦¬ëœ Volume ë°ì´í„° ì‚¬ìš©
                type: 'column', name: 'ê±°ë˜ëŸ‰', data: volumeData, yAxis: 1,
                dataGrouping: { units: [['day', [1]]] }
            }, {
                // ì‹œë¦¬ì¦ˆ 2: RSI
                type: 'rsi', name: 'RSI(14)', linkedTo: mainSeriesId, yAxis: 2, 
                tooltip: { valueDecimals: 2 }, params: { period: 14 }
            }, {
                // ì‹œë¦¬ì¦ˆ 3: MACD (íˆìŠ¤í† ê·¸ë¨ ì œê±°)
                type: 'macd', name: 'MACD(12, 26, 9)', linkedTo: mainSeriesId, yAxis: 3, 
                showInHistogram: false, 
                styles: { 
                    macdLine: { strokeWidth: 1, stroke: UP_COLOR }, 
                    signalLine: { strokeWidth: 1, stroke: DOWN_COLOR }, 
                    columns: { color: 'transparent', upColor: 'transparent', strokeWidth: 0 }
                },
                tooltip: { valueDecimals: 3 }
            }]
        });

    </script>














</body>
